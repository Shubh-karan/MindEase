<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindEase - Chat</title>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Shadows+Into+Light&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic&display=swap');

        :root {
            --bg-gradient: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgba(0,212,255,1) 100%);
            --header-bg: rgba(255, 255, 255, 0.1);
            --chat-bg: rgba(255, 255, 255, 0.05);
            --input-bg: rgba(0, 0, 0, 0.2);
            --text-color: white;
            --bot-bubble-bg: rgba(255, 255, 255, 0.95);
            --bot-text: #333;
            --modal-bg: #1a1a2e;
            --card-border: rgba(255,255,255,0.1);
        }

        body.dark-mode {
            --bg-gradient: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            --header-bg: rgba(20, 20, 20, 0.8);
            --chat-bg: rgba(20, 20, 20, 0.4);
            --input-bg: rgba(0, 0, 0, 0.6);
            --text-color: #e0e0e0;
            --bot-bubble-bg: rgba(40, 40, 40, 0.95);
            --bot-text: #eee;
            --modal-bg: #0f0f1a;
            --card-border: rgba(255,255,255,0.05);
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-gradient);
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            overflow: hidden;
            transition: background 0.5s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            z-index: 10;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: 0.3s;
        }
        .header h2 { font-family: "Caveat", cursive; margin: 0; font-size: 2.2rem; }
        .header-right { display: flex; gap: 12px; align-items: center; }

        .header-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .header-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }
        
        .gift-btn { background: rgba(255, 215, 0, 0.2); border-color: rgba(255, 215, 0, 0.5); color: #fff; animation: floatGift 3s infinite ease-in-out; }
        .gift-btn:hover { background: rgba(255, 215, 0, 0.4); }
        @keyframes floatGift { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        .emergency-btn { background: rgba(255, 82, 82, 0.2); border-color: rgba(255, 82, 82, 0.5); color: #ffcbcb; font-weight: 600; }
        .emergency-btn:hover { background: rgba(255, 82, 82, 0.4); }
        
        .logout-icon { 
            text-decoration: none; 
            color: rgba(255,255,255,0.8);
            padding: 8px; 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .logout-icon:hover { 
            background: rgba(255, 82, 82, 0.2); 
            border-color: #ff5252;
            color: #ff5252;
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 0 15px rgba(255, 82, 82, 0.3);
        }

        #chat-box {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: var(--chat-bg);
            margin: 0;
            backdrop-filter: blur(5px);
            scrollbar-width: thin; 
            transition: background 0.3s;
        }
        .bubble {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 1rem;
            animation: fadeIn 0.3s ease;
            position: relative;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user { align-self: flex-end; background-color: #00d2ff; color: #00334e; border-bottom-right-radius: 2px; font-weight: 500; }
        .bot { align-self: flex-start; background-color: var(--bot-bubble-bg); color: var(--bot-text); border-bottom-left-radius: 2px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        form { display: flex; padding: 20px; background: var(--input-bg); backdrop-filter: blur(10px); align-items: center; gap: 10px; transition: 0.3s; }
        input { flex: 1; padding: 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; outline: none; font-family: 'Poppins', sans-serif; font-size: 1rem; transition: 0.3s; }
        input:focus { background: rgba(255,255,255,0.2); border-color: #00d2ff; }
        
        .lang-select { padding: 10px; border-radius: 12px; border: none; outline: none; font-family: 'Poppins', sans-serif; cursor: pointer; background: rgba(255,255,255,0.9); color: #333; max-width: 100px; font-size: 0.85rem; }
        
        .mic-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: rgba(255,255,255,0.15); color: white; font-size: 1.2rem; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; }
        .mic-btn:hover { background: rgba(255,255,255,0.3); }
        .mic-btn.recording { background: #ff5252; animation: pulse 1.5s infinite; }
        .send-btn { padding: 12px 25px; background: linear-gradient(90deg, #00d2ff, #3a7bd5); border: none; color: white; border-radius: 30px; font-size: 1rem; cursor: pointer; transition: 0.3s; font-weight: 600; box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3); }
        .send-btn:hover { transform: scale(1.05); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .modal-overlay, .gm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(8px); animation: fadeModal 0.2s ease-out; }
        @keyframes fadeModal { from { opacity: 0; } to { opacity: 1; } }
        
        .gm-card { width:90%; max-width:800px; background: var(--modal-bg); border: 1px solid var(--card-border); border-radius:20px; padding:30px; color:#eef6ff; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        
        .close-btn { margin-top: 20px; background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 25px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .close-btn:hover { background: white; color: black; }
        .icon-close-btn { background: transparent; border: none; color: rgba(255, 255, 255, 0.6); font-size: 1.5rem; cursor: pointer; padding: 5px; line-height: 1; transition: 0.2s; }
        .icon-close-btn:hover { color: white; transform: scale(1.1); }

        .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; margin-top: 20px; }
        .tool-card { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; color: white; font-family: 'Poppins', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
        .tool-card:hover { background: rgba(255,255,255,0.2); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .tool-card span { font-size: 2.5rem; }
        .tool-card h4 { margin: 0; font-weight: 500; font-size: 1rem; }

        .gm-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .gm-tabs { display:flex; gap:10px; margin-bottom:20px; }
        .gm-tab { padding:8px 16px; border-radius:20px; background: rgba(255,255,255,0.05); cursor:pointer; font-size: 0.9rem; transition: 0.2s; }
        .gm-tab.active { background: #00d2ff; color: #000; font-weight: 600; }
        .gm-grid { display:flex; gap:20px; flex-wrap:wrap; }
        .gm-left { flex:2; min-width:300px; }
        .gm-right { flex:1; background: rgba(255,255,255,0.03); padding:20px; border-radius:15px; min-width: 200px; }
        .gm-playfield { position:relative; height:350px; border-radius:12px; background: rgba(0,0,0,0.4); overflow:hidden; border:1px solid rgba(255,255,255,0.05); }
        .gm-bubble { position:absolute; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; cursor:pointer; transition: transform 0.1s; user-select:none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .cm-grid, .mem-grid { display:grid; gap:10px; height: 350px; }
        .cm-grid { grid-template-columns:repeat(3, 1fr); grid-template-rows:repeat(3, 1fr); }
        .mem-grid { grid-template-columns:repeat(4, 1fr); grid-template-rows:repeat(4, 1fr); }
        .game-tile { width:100%; height:100%; border-radius:8px; cursor:pointer; transition: transform 0.1s; }
        .mem-card { position: relative; transform-style: preserve-3d; transition: transform 0.3s; }
        .mem-card.flipped { transform: rotateY(180deg); }
        .mem-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 2rem; border-radius: 8px; }
        .mem-front { background: linear-gradient(45deg, #3a7bd5, #00d2ff); }
        .mem-back { background: white; color: #333; transform: rotateY(180deg); }

        .zen-bg { background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); color: #e0e0e0; }
        .zen-input-container { text-align: center; width: 500px; max-width: 90%; }
        .zen-input { width: 100%; padding: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 10px; font-family: 'Poppins', sans-serif; margin-top: 20px; font-size: 1.1rem; }
        .story-container { width: 70%; min-height: 200px; text-align: center; font-family: 'Zen Maru Gothic', sans-serif; font-size: 1.5rem; line-height: 1.8; color: #ffd700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); display: none; margin-top: 30px; }
        
        .paper-container { width: 300px; height: 400px; background: #f8f9fa; color: #333; padding: 25px; border-radius: 5px; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: rotate(-2deg); }
        .paper-textarea { width: 100%; height: 80%; border: none; background: transparent; resize: none; font-family: 'Shadows Into Light', cursive; font-size: 1.6rem; outline: none; color: #333; line-height: 1.5; }
        .destroy-btn { width: 100%; padding: 12px; background: #ff5252; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; font-family: 'Poppins', sans-serif; font-weight: 600; letter-spacing: 1px; }
        .shred-strip { position: absolute; top: 0; width: 10%; height: 100%; background: #f8f9fa; border-right: 1px solid rgba(0,0,0,0.05); transition: 1s ease-in; }
        .shred-content { position: absolute; top: 25px; left: 0; width: 300px; padding: 0 25px; font-family: 'Shadows Into Light', cursive; font-size: 1.6rem; color: #333; pointer-events: none; }
        
        .timer-display { font-size: 7rem; font-weight: 600; color: white; text-shadow: 0 0 30px rgba(255, 193, 7, 0.5); margin: 20px 0; }
        .circle-container { height: 300px; width: 300px; display: flex; justify-content: center; align-items: center; position: relative; }
        .circle { background-color: #fff; height: 100%; width: 100%; border-radius: 50%; position: absolute; opacity: 0.8; transform: scale(0.3); box-shadow: 0 0 60px rgba(255,255,255,0.4); }
        .grow { animation: grow 4s linear forwards; } .shrink { animation: shrink 4s linear forwards; }
        @keyframes grow { from { transform: scale(0.3); } to { transform: scale(1); } }
        @keyframes shrink { from { transform: scale(1); } to { transform: scale(0.3); } }
        
        .emergency-box { background: #fff; color: #333; padding: 30px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .em-btn { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 12px; font-size: 1rem; cursor: pointer; font-weight: 600; transition: 0.2s; text-align: left; padding-left: 20px; display: flex; align-items: center; gap: 10px; }
        .em-loc { background: #e3f2fd; color: #1565c0; }
        .em-call { background: #ffebee; color: #c62828; }
        .em-help { background: #fff3e0; color: #ef6c00; }
        .em-close { background: #f5f5f5; color: #333; justify-content: center; margin-top: 20px; }

        #calendar-modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); z-index: 2200; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .calendar-card { width: 90%; max-width: 900px; height: 85vh; background: #fff; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; color: #333; }
        #calendar { flex-grow: 1; margin-top: 15px; font-family: 'Poppins', sans-serif; }
        .fc-toolbar-title { font-size: 1.5rem !important; font-weight: 600; }
        .fc-button { background-color: #00d2ff !important; border: none !important; font-weight: 500 !important; text-transform: capitalize !important; }

        #gm-confetti { position: fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:3000; display:none; }

        @media (max-width: 768px) {
            .header { padding: 15px; }
            .header h2 { font-size: 1.8rem; }
            .header-btn span { display: block; font-size: 1.4rem; } 
            .header-btn-text { display: none; } 
            .tools-grid { grid-template-columns: 1fr; }
            .story-container { width: 90%; font-size: 1.2rem; }
            form { flex-wrap: wrap; }
            input { width: 100%; }
        }
    </style>
</head>

<body>

    <div class="header">
        <h2>MindEase</h2>
        <div class="header-right">
            <button class="header-btn gift-btn" onclick="openGift()" title="Daily Gift" data-intro="Click here daily for a mental health boost! üéÅ">
                <span>üéÅ</span> <span class="header-btn-text">Gift</span>
            </button>
            <button class="header-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode" data-intro="Switch between Light and Dark mode.">
                <span id="dark-icon">üåô</span>
            </button>
            <button class="header-btn emergency-btn" onclick="openEmergency()" data-intro="Quick access to helplines and safety tools.">
                <span>üö®</span> <span class="header-btn-text">SOS</span>
            </button>
            <button class="header-btn" onclick="openTools()" data-intro="Access ZenStory, Shredder, Focus Timer, and Games here!">
                <span>üõ†Ô∏è</span> <span class="header-btn-text">Toolkit</span>
            </button>
            <a href="#" onclick="promptFeedback(event)" class="logout-icon" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
            </a>
        </div>
    </div>

    <div id="chat-box">
        <div class="bubble bot">Hello {{ username }}! I'm MindEase. I can listen and speak in many languages. How can I help you today? üåø</div>
    </div>

    <form id="chat-form" data-intro="Type your message here or use the microphone to speak!">
        <select id="language-select" class="lang-select" onchange="saveSettings()">
            <option value="en-US">English</option>
            <option value="hi-IN">Hindi</option>
            <option value="es-ES">Spanish</option>
            <option value="fr-FR">French</option>
        </select>

        <input type="text" id="user-input" placeholder="Type or speak..." autocomplete="off"/>
        
        <button type="button" id="mic-btn" class="mic-btn" onclick="toggleRecording()">üé§</button>
        <button type="submit" class="send-btn">Send</button>
    </form>

    <div id="tools-modal" class="modal-overlay">
        <div class="gm-card" style="max-width: 500px; background: rgba(30, 30, 40, 0.95); border: 1px solid rgba(255,255,255,0.1);">
            <div class="gm-header" style="border:none; margin-bottom:10px;">
                <h3 style="margin:0; font-size:1.5rem;">Wellness Toolkit</h3>
                <button class="icon-close-btn" onclick="closeTools()">‚úï</button>
            </div>
            <p style="margin:0 0 20px 0; color:#aaa; font-size:0.9rem;">Select a tool to help you relax and focus.</p>
            
            <div class="tools-grid">
                <div class="tool-card" onclick="openZen()" style="color: #e0b0ff;"><span>üåå</span><h4>ZenStory</h4></div>
                <div class="tool-card" onclick="openShredder()" style="color: #ef9a9a;"><span>üóëÔ∏è</span><h4>Worry Shredder</h4></div>
                <div class="tool-card" onclick="openFocus()" style="color: #ffe082;"><span>‚è±Ô∏è</span><h4>Focus Timer</h4></div>
                <div class="tool-card" onclick="openBreathing()" style="color: #80deea;"><span>üå¨Ô∏è</span><h4>Breathe</h4></div>
                <div class="tool-card" onclick="openGames()" style="color: #90caf9;"><span>üéÆ</span><h4>Mini Games</h4></div>
            </div>
        </div>
    </div>

    <div id="gift-modal" class="modal-overlay">
        <div class="gm-card" style="max-width: 400px; text-align: center; background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%); color: #333;">
            <div class="gm-header" style="border:none; justify-content:center;">
                <h2 style="font-size:3rem; margin:0;">üéÅ</h2>
            </div>
            <h3 style="margin:10px 0; color:#333;">Your Daily Spark</h3>
            <p id="gift-content" style="font-size:1.2rem; font-weight:600; margin:20px 0; line-height:1.5;">Loading your gift...</p>
            <button class="close-btn" onclick="closeGift()" style="border-color:#333; color:#333;">Awesome!</button>
        </div>
    </div>
    
    <div id="zen-modal" class="modal-overlay zen-bg"><div id="zen-input-box" class="zen-input-container"><h2 style="font-weight:300;">What is weighing on your mind?</h2><p>I will weave a calming story just for this.</p><input type="text" id="zen-topic" class="zen-input" placeholder="e.g., My physics exam..." autocomplete="off"><button class="header-btn zen-btn" style="width:100%;margin-top:15px;justify-content:center;" onclick="generateZenStory()">Weave Story ‚ú®</button></div><div id="zen-loading" style="display:none;text-align:center;"><div style="font-size:3rem;animation:spin 3s infinite linear;">‚ú®</div><p>Consulting the stars...</p></div><div id="zen-story-display" class="story-container"></div><button class="close-btn" onclick="closeZen()">Return</button></div>
    <div id="shredder-modal" class="modal-overlay"><div class="paper-container" id="paper"><textarea class="paper-textarea" id="worry-input" placeholder="Write your worry here..."></textarea><button class="destroy-btn" onclick="shredPaper()">DESTROY WORRY</button></div><div id="shred-message" style="display:none;text-align:center;"><h2>Gone. üçÉ</h2><p>You've let it go.</p></div><button class="close-btn" onclick="closeShredder()">Close</button></div>
    <div id="breathing-modal" class="modal-overlay"><div class="circle-container"><div class="circle" id="breathing-circle"></div><p id="instruction" style="font-size:2rem;z-index:10;">Get Ready...</p></div><button class="close-btn" onclick="closeBreathing()">Stop Exercise</button></div>
    <div id="focus-modal" class="modal-overlay"><p style="font-size:1.5rem;margin-bottom:20px;">Focus Timer</p><div class="timer-display" id="timer">25:00</div><button class="close-btn" onclick="closeFocus()">End Session</button></div>
    
    <div id="emergency-modal" class="modal-overlay">
        <div class="emergency-box">
            <h2 style="color:#c62828; margin-top:0;">‚ö†Ô∏è Emergency</h2>
            <p>If you are in danger, use these options.</p>
            <button class="em-btn em-loc" onclick="shareLocation()">üìç Share My Location</button>
            <a href="tel:112" style="text-decoration:none;"><button class="em-btn em-call">üìû Call Emergency (112)</button></a>
            <button class="em-btn em-help" onclick="openContacts()">üë• Emergency Contacts</button>
            <div id="helpline-list" style="text-align:left; margin-top:12px; background:#fafafa; padding:10px; border-radius:8px;">
                <p><strong>Helplines:</strong></p>
                <p>‚Ä¢ Police: 100</p>
                <p>‚Ä¢ Ambulance: 108</p>
                <p>‚Ä¢ Mental Health: 14416</p>
            </div>
            <button class="em-btn em-close" onclick="closeEmergency()">Close</button>
        </div>
    </div>

    <div id="contacts-modal" class="modal-overlay">
        <div class="emergency-box">
            <h3 style="margin-top:0;">Emergency Contacts</h3>
            <p style="font-size:0.9rem; margin-bottom:15px;">Add trusted contacts for quick access.</p>
            <input type="text" id="contact-name" class="zen-input" placeholder="Name" style="color:#333; background:#f5f5f5; border:1px solid #ddd; margin-top:0; margin-bottom:10px;">
            <input type="tel" id="contact-number" class="zen-input" placeholder="Phone Number" style="color:#333; background:#f5f5f5; border:1px solid #ddd; margin-top:0; margin-bottom:15px;">
            <button class="em-btn em-loc" onclick="saveContact()" style="justify-content:center;">Save Contact</button>
            <div id="saved-contacts" style="text-align:left; margin-top:20px; max-height: 150px; overflow-y:auto;"></div>
            <button class="em-btn em-close" onclick="closeContacts()">Back</button>
        </div>
    </div>

    <div id="feedback-modal" class="modal-overlay">
        <div class="gm-card" style="max-width: 400px; text-align: center; background: #fff; color: #333;">
            <div class="gm-header" style="border-bottom: 1px solid #eee; margin-bottom: 20px;">
                <h3 style="margin:0; color:#333;">üëã Before you go...</h3>
                <button class="icon-close-btn" onclick="continueLogout()" style="color:#333;">‚úï</button>
            </div>
            <p style="font-size:1rem; margin-bottom: 15px;">How was your MindEase experience today?</p>
            <textarea id="feedback-input" style="width: 90%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; resize: none; font-family: 'Poppins', sans-serif;" placeholder="Your feedback helps us improve!"></textarea>
            <button class="em-btn em-call" onclick="submitFeedbackAndLogout()" style="background:#00d2ff; color:white; justify-content:center; width:90%; margin-bottom: 10px;">Submit & Logout</button>
            <button class="em-btn em-close" onclick="continueLogout()" style="justify-content:center; width:90%; background:#f5f5f5;">Skip & Logout</button>
        </div>
    </div>

    <div id="gm-modal" class="gm-modal"><div class="gm-card"><div class="gm-header"><h3>Stress Relief Games</h3><button class="icon-close-btn" onclick="closeGames()">‚úï</button></div><div class="gm-tabs"><div class="gm-tab active" data-tab="tab-bubbles" onclick="switchTab(event)">Pop Bubbles</div><div class="gm-tab" data-tab="tab-color" onclick="switchTab(event)">Color Match</div><div class="gm-tab" data-tab="tab-memory" onclick="switchTab(event)">Memory Pairs</div></div><div class="gm-grid"><div class="gm-left"><div id="tab-bubbles" class="gm-panel"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><div>Score: <span id="sb_score">0</span></div><div>Time: <span id="sb_time">30</span>s</div><div><button class="header-btn" onclick="sb_stop()">Stop</button><button class="header-btn" onclick="sb_reset()">Reset</button><button class="header-btn" onclick="sb_start()">Start</button></div></div><div id="gm-playfield" class="gm-playfield"></div></div><div id="tab-color" class="gm-panel" style="display:none;"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><div>Score: <span id="cm_score">0</span></div><div>Time: <span id="cm_time">30</span>s</div><div><button class="header-btn" onclick="cm_stop()">Stop</button><button class="header-btn" onclick="cm_reset()">Reset</button><button class="header-btn" onclick="cm_start()">Start</button></div></div><div style="margin-bottom:10px;">Target: <span id="cm_target" style="display:inline-block; width:30px; height:20px; border-radius:4px; vertical-align:middle;"></span></div><div id="cm_grid" class="cm-grid"></div></div><div id="tab-memory" class="gm-panel" style="display:none;"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><div>Moves: <span id="mem_moves">0</span></div><div><button class="header-btn" onclick="mem_reset()">Reset</button><button class="header-btn" onclick="mem_start()">Start</button></div></div><div id="mem_grid" class="mem-grid"></div></div></div><div class="gm-right"><h4>High Scores</h4><p>Bubbles: <span id="hs_bubbles">0</span></p><p>Color Match: <span id="hs_color">0</span></p><p>Memory: <span id="hs_mem">--</span></p></div></div></div></div>
    
    <div id="calendar-modal"><div class="calendar-card"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="color:#333; margin:0;">Mood History</h3><button class="close-btn" onclick="closeCalendar()" style="margin-top:0; color:#333; border-color:#ccc;">Close</button></div><div id="calendar"></div></div></div>

    <canvas id="gm-confetti"></canvas>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            closeAllModals(); 

            if (!localStorage.getItem("seen_tutorial")) {
                introJs().setOptions({
                    steps: [
                        { intro: "üëã Welcome to MindEase! Let me show you around." },
                        { element: '#chat-form', intro: "Type here or use the üé§ mic to talk to your AI companion." },
                        { element: '.gift-btn', intro: "üéÅ Click here every day for a surprise positive boost!" },
                        { element: document.querySelector('button[onclick="openTools()"]'), intro: "üõ†Ô∏è Open the Toolkit to find ZenStory, Games, and Focus tools." },
                        { element: '.emergency-btn', intro: "üö® Quick access to emergency help is always here." }
                    ]
                }).start();
                localStorage.setItem("seen_tutorial", "true");
            }
        });

        const chatBox = document.getElementById("chat-box");
        let voices = [];
        function loadVoices() { voices = window.speechSynthesis.getVoices(); }
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        const savedLang = "{{ user_settings.get('language', 'en-US') }}";
        const langSelect = document.getElementById("language-select");
        if(langSelect) langSelect.value = savedLang;

        function addMessage(text, sender) {
            const div = document.createElement("div"); div.className = `bubble ${sender}`; div.textContent = text;
            chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const langCode = document.getElementById("language-select").value;
            utterance.lang = langCode;
            const exactMatch = voices.find(voice => voice.lang === langCode);
            if (exactMatch) utterance.voice = exactMatch;
            utterance.rate = 0.9; 
            window.speechSynthesis.speak(utterance);
        }
        
        function saveSettings() {
            const lang = document.getElementById("language-select").value;
            fetch('/api/save_settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ language: lang })
            });
        }

        function openGift() {
            document.getElementById("gift-modal").style.display = "flex";
            document.getElementById("gift-content").innerText = "Unwrapping...";
            fetch('/api/daily_gift')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById("gift-content").innerText = data.gift;
                        spawnConfetti();
                    } else {
                        document.getElementById("gift-content").innerText = data.message;
                    }
                })
                .catch(err => {
                    document.getElementById("gift-content").innerText = "Could not fetch gift. Try again later!";
                });
        }
        function closeGift() {
            document.getElementById("gift-modal").style.display = "none";
        }

        let mediaRecorder;
        let audioChunks = [];
        const micBtn = document.getElementById("mic-btn");
        const userInput = document.getElementById("user-input");

        async function toggleRecording() {
            if (micBtn.classList.contains("recording")) {
                mediaRecorder.stop();
                micBtn.classList.remove("recording");
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const formData = new FormData();
                        formData.append("file", audioBlob, "recording.webm");
                        userInput.value = "üé§ Transcribing...";
                        userInput.disabled = true;
                        const res = await fetch("/transcribe", { method: "POST", body: formData });
                        const data = await res.json();
                        userInput.disabled = false;
                        userInput.value = data.text || "";
                        if (data.text) document.getElementById("chat-form").dispatchEvent(new Event('submit'));
                        else userInput.placeholder = "Could not hear you.";
                    };
                    mediaRecorder.start();
                    micBtn.classList.add("recording");
                } catch (err) { alert("Mic access denied."); }
            }
        }

        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("user-input");
            const message = input.value.trim(); if (!message) return;
            addMessage(message, "user"); input.value = "";
            const loadingDiv = document.createElement("div"); loadingDiv.className = "bubble bot"; loadingDiv.textContent = "..."; loadingDiv.id = "loading-bubble";
            chatBox.appendChild(loadingDiv); chatBox.scrollTop = chatBox.scrollHeight;
            try {
                const res = await fetch("/chat/message", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ message }) });
                const data = await res.json();
                document.getElementById("loading-bubble").remove(); 
                addMessage(data.reply, "bot");
                speakText(data.reply);
            } catch (error) {
                if(document.getElementById("loading-bubble")) document.getElementById("loading-bubble").remove();
                addMessage("Connection error.", "bot");
            }
        });

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('dark-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.textContent = '‚òÄÔ∏è';
            } else {
                icon.textContent = 'üåô';
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay, .gm-modal, #calendar-modal').forEach(el => el.style.display = 'none');
        }
        
        function openTools() { closeAllModals(); document.getElementById("tools-modal").style.display = "flex"; }
        function closeTools() { document.getElementById("tools-modal").style.display = "none"; }

        function openZen() { closeTools(); document.getElementById("zen-modal").style.display = "flex"; document.getElementById("zen-input-box").style.display = "block"; document.getElementById("zen-story-display").style.display = "none"; document.getElementById("zen-story-display").innerText = ""; }
        function closeZen() { closeAllModals(); }
        async function generateZenStory() {
            const topic = document.getElementById("zen-topic").value; if(!topic) return;
            document.getElementById("zen-input-box").style.display = "none";
            document.getElementById("zen-loading").style.display = "block";
            try {
                const res = await fetch("/zen_mode", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ worry: topic }) });
                const data = await res.json();
                document.getElementById("zen-loading").style.display = "none";
                const storyDiv = document.getElementById("zen-story-display");
                storyDiv.style.display = "block";
                let i = 0; const txt = data.story; const speed = 40;
                function typeWriter() { if (i < txt.length) { storyDiv.innerHTML += txt.charAt(i); i++; setTimeout(typeWriter, speed); } }
                typeWriter();
            } catch(e) { alert("Star connection failed."); closeZen(); }
        }

        function openShredder() { closeTools(); document.getElementById("shredder-modal").style.display = "flex"; document.getElementById("paper").style.display = "block"; document.getElementById("paper").innerHTML = `<textarea class="paper-textarea" id="worry-input" placeholder="Write your worry here..."></textarea><button class="destroy-btn" onclick="shredPaper()">DESTROY WORRY</button>`; document.getElementById("shred-message").style.display = "none"; }
        function closeShredder() { closeAllModals(); }
        function shredPaper() {
            const paper = document.getElementById("paper"); const text = document.getElementById("worry-input").value; if(!text) return;
            paper.innerHTML = ""; paper.style.background = "transparent"; paper.style.boxShadow = "none";
            const stripCount = 10; const stripWidth = 100 / stripCount;
            for(let i=0; i<stripCount; i++) {
                const strip = document.createElement("div"); strip.className = "shred-strip"; strip.style.left = (i * stripWidth) + "%"; strip.style.width = stripWidth + "%";
                const content = document.createElement("div"); content.className = "shred-content"; content.innerText = text; content.style.left = -(i * 30) + "px";
                strip.appendChild(content); paper.appendChild(strip);
                setTimeout(() => { strip.style.transform = `translateY(${400 + Math.random() * 200}px) rotate(${Math.random() * 20 - 10}deg)`; strip.style.opacity = "0"; }, i * 50);
            }
            setTimeout(() => { document.getElementById("paper").style.display = "none"; document.getElementById("shred-message").style.display = "block"; }, 1500);
        }

        let timerInterval, timeLeft, breathInterval;
        function openFocus() { closeTools(); document.getElementById("focus-modal").style.display = "flex"; timeLeft = 25*60; document.getElementById("timer").innerText = "25:00"; timerInterval = setInterval(() => { if(timeLeft<=0) { clearInterval(timerInterval); document.getElementById("timer").innerText = "Done!"; return; } timeLeft--; let m = Math.floor(timeLeft/60); let s = timeLeft%60; document.getElementById("timer").innerText = `${m}:${s<10?'0':''}${s}`; }, 1000); }
        function closeFocus() { closeAllModals(); clearInterval(timerInterval); }
        function openBreathing() { closeTools(); document.getElementById("breathing-modal").style.display = "flex"; const c = document.getElementById("breathing-circle"); const i = document.getElementById("instruction"); i.innerText = "Inhale..."; c.className = 'circle grow'; const cycle = () => { i.innerText = "Inhale..."; c.className = 'circle grow'; setTimeout(() => { i.innerText = "Exhale..."; c.className = 'circle shrink'; }, 4000); }; cycle(); breathInterval = setInterval(cycle, 8000); }
        function closeBreathing() { closeAllModals(); clearInterval(breathInterval); }

        function openEmergency() { closeAllModals(); document.getElementById('emergency-modal').style.display = 'flex'; }
        function closeEmergency() { document.getElementById('emergency-modal').style.display = 'none'; }
        function shareLocation() { if(!navigator.geolocation) return alert('Not supported'); navigator.geolocation.getCurrentPosition(pos => { const t = `Help! My Location: ${pos.coords.latitude}, ${pos.coords.longitude}`; navigator.clipboard.writeText(t); alert('Location copied to clipboard!'); }); }
        let alarmPlaying = false;
        function toggleAlarm() { const a = document.getElementById('alarm-sound'); if(!alarmPlaying) { a.play(); alarmPlaying=true; } else { a.pause(); a.currentTime=0; alarmPlaying=false; } }
        
        function openContacts() {
            closeAllModals();
            document.getElementById('contacts-modal').style.display = 'flex';
            loadContacts();
        }
        
        function closeContacts() {
            document.getElementById('contacts-modal').style.display = 'none';
            document.getElementById('emergency-modal').style.display = 'flex';
        }

        function saveContact() {
            const name = document.getElementById('contact-name').value;
            const number = document.getElementById('contact-number').value;
            if (!name || !number) return alert("Please enter name and number");
            
            const contacts = JSON.parse(localStorage.getItem('emergency_contacts') || '[]');
            contacts.push({name, number});
            localStorage.setItem('emergency_contacts', JSON.stringify(contacts));
            
            document.getElementById('contact-name').value = '';
            document.getElementById('contact-number').value = '';
            loadContacts();
        }

        function loadContacts() {
            const list = document.getElementById('saved-contacts');
            list.innerHTML = '';
            const contacts = JSON.parse(localStorage.getItem('emergency_contacts') || '[]');
            
            if (contacts.length === 0) {
                list.innerHTML = '<p style="color:#777; font-size:0.9rem;">No contacts added yet.</p>';
                return;
            }

            contacts.forEach((c, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'background:#f5f5f5; padding:10px; margin-bottom:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600;">${c.name}</div>
                        <a href="tel:${c.number}" style="color:#00d2ff; text-decoration:none; font-size:0.9rem;">${c.number}</a>
                    </div>
                    <button onclick="deleteContact(${index})" style="background:#ff5252; color:white; border:none; border-radius:5px; padding:5px 10px; cursor:pointer;">üóëÔ∏è</button>
                `;
                list.appendChild(div);
            });
        }

        function deleteContact(index) {
            const contacts = JSON.parse(localStorage.getItem('emergency_contacts') || '[]');
            contacts.splice(index, 1);
            localStorage.setItem('emergency_contacts', JSON.stringify(contacts));
            loadContacts();
        }

        function openGames() { closeTools(); document.getElementById('gm-modal').style.display='flex'; loadHS(); }
        function closeGames() { document.getElementById('gm-modal').style.display='none'; clearInterval(sb_interval); clearInterval(cm_timer); }
        function switchTab(e) { document.querySelectorAll('.gm-tab').forEach(t=>t.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('.gm-panel').forEach(p=>p.style.display='none'); document.getElementById(e.target.dataset.tab).style.display='block'; }

        function loadHS() { const h = JSON.parse(localStorage.getItem('gm_highs') || '{}'); document.getElementById('hs_bubbles').innerText = h.bubbles || 0; document.getElementById('hs_color').innerText = h.color || 0; document.getElementById('hs_mem').innerText = h.mem || '--'; }
        function setHS(k, v) { const h = JSON.parse(localStorage.getItem('gm_highs') || '{}'); if(k==='mem' && h.mem && v >= h.mem) return; if(k!=='mem' && h[k] && v <= h[k]) return; h[k]=v; localStorage.setItem('gm_highs', JSON.stringify(h)); loadHS(); spawnConfetti(); }

        const confCanvas = document.getElementById('gm-confetti'); const confCtx = confCanvas.getContext('2d');
        function spawnConfetti() { confCanvas.style.display='block'; confCanvas.width=window.innerWidth; confCanvas.height=window.innerHeight; const p=[]; for(let i=0;i<50;i++) p.push({x:Math.random()*confCanvas.width, y:-10, vx:Math.random()*4-2, vy:Math.random()*4+2, c:'#'+Math.floor(Math.random()*16777215).toString(16)}); 
            function loop() { confCtx.clearRect(0,0,confCanvas.width,confCanvas.height); let active=false; p.forEach(pts=>{ pts.x+=pts.vx; pts.y+=pts.vy; if(pts.y<confCanvas.height) active=true; confCtx.fillStyle=pts.c; confCtx.fillRect(pts.x,pts.y,5,5); }); if(active) requestAnimationFrame(loop); else confCanvas.style.display='none'; } loop(); }

        let sb_score=0, sb_time=30, sb_interval;
        function sb_start() { sb_score=0; sb_time=30; document.getElementById('sb_score').innerText=0; document.getElementById('sb_time').innerText=30; document.getElementById('gm-playfield').innerHTML=''; 
            sb_interval = setInterval(() => { sb_time--; document.getElementById('sb_time').innerText=sb_time; if(sb_time<=0) { clearInterval(sb_interval); alert('Game Over! Score: '+sb_score); setHS('bubbles', sb_score); } else spawnBubble(); }, 1000); spawnBubble(); }
        function spawnBubble() { const b = document.createElement('div'); b.className='gm-bubble'; const s = Math.random()*40+30; b.style.width=s+'px'; b.style.height=s+'px'; b.style.left=Math.random()*90+'%'; b.style.top=Math.random()*80+'%'; b.style.background=`hsl(${Math.random()*360},70%,60%)`; b.innerText = Math.floor(100/s); 
            b.onclick = function() { sb_score+=parseInt(this.innerText); document.getElementById('sb_score').innerText=sb_score; this.remove(); }; document.getElementById('gm-playfield').appendChild(b); setTimeout(()=>b.remove(), 2000); }
        
        function sb_stop() {
            clearInterval(sb_interval);
            alert('Game Paused. Click Start to resume.');
        }

        function sb_reset() {
            clearInterval(sb_interval);
            sb_score = 0;
            sb_time = 30;
            document.getElementById('sb_score').innerText = 0;
            document.getElementById('sb_time').innerText = 30;
            document.getElementById('gm-playfield').innerHTML = '';
        }

        let cm_score=0, cm_time=30, cm_timer;
        function cm_start() { cm_score=0; cm_time=30; document.getElementById('cm_score').innerText=0; document.getElementById('cm_time').innerText=30; cm_build(); 
            cm_timer = setInterval(() => { cm_time--; document.getElementById('cm_time').innerText=cm_time; if(cm_time<=0) { clearInterval(cm_timer); alert('Game Over! Score: '+cm_score); setHS('color', cm_score); } }, 1000); }
        function cm_build() { const grid = document.getElementById('cm_grid'); grid.innerHTML=''; 
            const hue = Math.floor(Math.random()*360); 
            const target = `hsl(${hue},70%,50%)`; 
            document.getElementById('cm_target').style.background=target; 
            const correct = Math.floor(Math.random()*9); 
            
            for(let i=0; i<9; i++) { 
                const t = document.createElement('div'); 
                t.className='game-tile'; 
                t.style.background = i===correct ? target : `hsl(${hue + (Math.random()*40-20)},70%,50%)`; 
                t.setAttribute('data-correct', i===correct);
                
                t.onclick = function() { 
                    if(this.getAttribute('data-correct') === 'true') { 
                        cm_score++; 
                        document.getElementById('cm_score').innerText=cm_score; 
                        cm_build(); 
                    } 
                }; 
                grid.appendChild(t); 
            } 
        }
        
        function cm_stop() {
            clearInterval(cm_timer);
            alert('Game Paused. Click Start to resume.');
        }

        function cm_reset() {
            clearInterval(cm_timer);
            cm_score = 0;
            cm_time = 30;
            document.getElementById('cm_score').innerText = 0;
            document.getElementById('cm_time').innerText = 30;
            document.getElementById('cm_grid').innerHTML = '';
            document.getElementById('cm_target').style.background = 'none';
        }

        let mem_cards=[], mem_flipped=[], mem_moves=0, mem_matches=0;
        const syms = ['‚òÖ','‚óè','‚ñ≤','‚ñ†','‚óÜ','‚ô•','‚ô£','‚úø'];
        function mem_start() { const grid = document.getElementById('mem_grid'); grid.innerHTML=''; mem_moves=0; mem_matches=0; document.getElementById('mem_moves').innerText=0; 
            let deck = [...syms, ...syms].sort(()=>0.5-Math.random()); 
            deck.forEach(s => { const c = document.createElement('div'); c.className='game-tile mem-card'; c.innerHTML=`<div class="mem-face mem-front"></div><div class="mem-face mem-back">${s}</div>`; 
                c.onclick = function() { if(this.classList.contains('flipped') || mem_flipped.length>=2) return; 
                    this.classList.add('flipped'); mem_flipped.push({el:this, val:s}); 
                    if(mem_flipped.length===2) { mem_moves++; document.getElementById('mem_moves').innerText=mem_moves; setTimeout(checkMem, 800); } }; grid.appendChild(c); }); }
        function checkMem() { if(mem_flipped[0].val === mem_flipped[1].val) { mem_matches++; if(mem_matches===8) { alert('You Won! Moves: '+mem_moves); setHS('mem', mem_moves); } } else { mem_flipped.forEach(c=>c.el.classList.remove('flipped')); } mem_flipped=[]; }
        
        function mem_reset() {
            document.getElementById('mem_grid').innerHTML = '';
            mem_moves = 0;
            mem_matches = 0;
            document.getElementById('mem_moves').innerText = 0;
            mem_flipped = [];
        }

        function promptFeedback(event) {
            event.preventDefault(); 
            closeAllModals(); 
            document.getElementById('feedback-modal').style.display = 'flex';
        }

        function continueLogout() {
            window.location.href = '/logout';
        }

        async function submitFeedbackAndLogout() {
            const feedbackText = document.getElementById('feedback-input').value.trim();
            if (feedbackText.length > 0) {
                try {
                    await fetch('/api/submit_feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ feedback: feedbackText })
                    });
                } catch (e) { console.error("Failed to submit feedback:", e); }
            }
            continueLogout();
        }

        function openCalendar() {
            closeTools();
            document.getElementById("calendar-modal").style.display = "flex";
            setTimeout(() => {
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    height: '100%',
                    headerToolbar: { start: 'prev,next', center: 'title', end: 'today' },
                    events: '/api/user_mood_history'
                });
                calendar.render();
            }, 100); 
        }
        function closeCalendar() { document.getElementById("calendar-modal").style.display = "none"; }

    </script>
  
</body>

</html>